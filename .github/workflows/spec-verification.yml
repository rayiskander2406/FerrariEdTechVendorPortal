# Specification Verification CI
# Ensures generated tests stay in sync with specification YAML
#
# This workflow:
# 1. Regenerates tests from vendor-portal-rules.yaml
# 2. Verifies no generated files have drifted
# 3. Runs all generated property-based tests
# 4. Fails PR if spec and tests are out of sync

name: Spec Verification

on:
  push:
    branches: [main, develop]
    paths:
      - 'spec/**'
      - 'lib/tokens/**'
      - 'tests/generated/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'spec/**'
      - 'lib/tokens/**'
      - 'tests/generated/**'

jobs:
  verify-spec:
    name: Verify Spec Sync
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Regenerate from spec
        run: npm run generate:spec

      - name: Check for drift
        run: |
          if git diff --exit-code tests/generated/; then
            echo "Generated tests are in sync with specification"
          else
            echo "ERROR: Generated tests have drifted from specification!"
            echo ""
            echo "The generated test files don't match what the spec would generate."
            echo "This usually means someone edited the generated files directly,"
            echo "or the spec was updated without regenerating tests."
            echo ""
            echo "To fix this, run: npm run generate:spec"
            echo "Then commit the regenerated files."
            exit 1
          fi

      - name: Check docs drift
        run: |
          if git diff --exit-code docs/generated/; then
            echo "Generated docs are in sync with specification"
          else
            echo "WARNING: Generated docs have drifted from specification"
            echo "Run: npm run generate:spec"
            exit 1
          fi

  run-generated-tests:
    name: Run Property-Based Tests
    runs-on: ubuntu-latest
    needs: verify-spec

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run generated tests
        run: npm run test:generated -- --reporter=verbose

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: coverage/

  axiom-validation:
    name: Validate Formal Axioms
    runs-on: ubuntu-latest
    needs: verify-spec

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run axiom tests (extended)
        run: |
          # Run property tests with more iterations for CI
          npm run test:generated -- \
            --reporter=verbose \
            --testTimeout=30000

      - name: Check axiom coverage
        run: |
          echo "Axiom Test Summary:"
          echo "==================="
          echo "- Injectivity: Verified via property-based tests"
          echo "- Roundtrip: Verified via token store registration"
          echo "- Format Preservation: Verified via regex patterns"
          echo "- Access Tier Enforcement: Verified via tier level tests"
          echo "- State Machine Validity: Verified via transition tests"
